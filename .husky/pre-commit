#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# ========================================
# PRE-COMMIT QUALITY GATES
# ========================================

echo "ğŸ” Running pre-commit quality checks..."

# 1. TypeScript compilation check
echo "ğŸ“ Checking TypeScript compilation..."
npx tsc --noEmit
if [ $? -ne 0 ]; then
  echo "âŒ TypeScript compilation failed"
  exit 1
fi

# 2. ESLint check (with auto-fix for simple issues)
echo "ğŸ”§ Running ESLint with auto-fix..."
npx eslint . --fix --max-warnings 0
if [ $? -ne 0 ]; then
  echo "âŒ ESLint checks failed"
  echo "ğŸ’¡ Run 'npm run lint' to see detailed errors"
  exit 1
fi

# 3. Prettier formatting check
echo "âœ¨ Checking code formatting..."
npx prettier --check .
if [ $? -ne 0 ]; then
  echo "âŒ Code formatting issues found"
  echo "ğŸ’¡ Run 'npx prettier --write .' to fix formatting"
  exit 1
fi

# 4. Security audit (fail on high severity)
echo "ğŸ”’ Running security audit..."
npm audit --audit-level high --omit dev
if [ $? -ne 0 ]; then
  echo "âš ï¸ High severity security vulnerabilities found"
  echo "ğŸ’¡ Run 'npm audit fix' to resolve issues"
  # Don't exit on audit failures in development
fi

# 5. Check for sensitive files
echo "ğŸ•µï¸ Checking for sensitive files..."
if [ -f ".env" ]; then
  echo "âš ï¸ .env file detected - ensure it's in .gitignore"
fi

# Check for potential secrets in staged files
git diff --cached --name-only | xargs grep -l "api[_-]key\|password\|secret\|token" 2>/dev/null
if [ $? -eq 0 ]; then
  echo "âš ï¸ Potential secrets detected in staged files"
  echo "ğŸ’¡ Please review and remove sensitive data"
fi

echo "âœ… All pre-commit checks passed!"